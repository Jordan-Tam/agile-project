{{> header}}
<main>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">Settings</h1>
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Theme Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="h4 mb-0">Appearance</h2>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="mb-1">Theme Mode</h5>
                                <p class="text-muted mb-0">Choose between light and dark mode</p>
                            </div>
                            <div class="theme-toggle-container">
                                <label class="theme-toggle">
                                    <input type="checkbox" id="themeToggle" class="theme-toggle-input">
                                    <span class="theme-toggle-slider">
                                        <span class="theme-toggle-icon theme-toggle-icon-light">‚òÄÔ∏è</span>
                                        <span class="theme-toggle-icon theme-toggle-icon-dark">üåô</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" id="resetThemeBtn" class="btn btn-secondary" style="display: none;">Reset</button>
                            <button type="button" id="saveThemeBtn" class="btn btn-primary" style="display: none;">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .theme-toggle-container {
        display: flex;
        align-items: center;
    }

    .theme-toggle {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 40px;
        cursor: pointer;
    }

    .theme-toggle-input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .theme-toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ffc107;
        border-radius: 40px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        padding: 4px;
    }

    .theme-toggle-slider:before {
        content: '';
        position: absolute;
        height: 32px;
        width: 32px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .theme-toggle-input:checked + .theme-toggle-slider {
        background-color: #1e3a8a;
    }

    .theme-toggle-input:checked + .theme-toggle-slider:before {
        transform: translateX(40px);
    }

    .theme-toggle-icon {
        position: absolute;
        font-size: 18px;
        transition: opacity 0.3s;
    }

    .theme-toggle-icon-light {
        left: 12px;
        opacity: 1;
    }

    .theme-toggle-icon-dark {
        right: 12px;
        opacity: 0;
    }

    .theme-toggle-input:checked + .theme-toggle-slider .theme-toggle-icon-light {
        opacity: 0;
    }

    .theme-toggle-input:checked + .theme-toggle-slider .theme-toggle-icon-dark {
        opacity: 1;
    }

    /* Dark mode styles for settings page */
    body.dark-mode .card {
        background-color: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
    }

    body.dark-mode .card-header {
        background-color: #1a202c;
        border-color: #4a5568;
        color: #e2e8f0;
    }

    body.dark-mode .text-muted {
        color: #a0aec0 !important;
    }

    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h5 {
        color: #e2e8f0;
    }
</style>

<script>
    // Initialize theme toggle - wait for theme-manager.js to load
    function initializeSettings() {
        // Wait for setTheme to be available (loaded from main layout)
        if (typeof setTheme === 'undefined') {
            setTimeout(initializeSettings, 50);
            return;
        }
        
        const themeToggle = document.getElementById('themeToggle');
        const saveThemeBtn = document.getElementById('saveThemeBtn');
        const resetThemeBtn = document.getElementById('resetThemeBtn');
        
        if (!themeToggle || !saveThemeBtn || !resetThemeBtn) {
            setTimeout(initializeSettings, 50);
            return;
        }
        
        // Get current theme - use user theme if available, otherwise default to light
        let originalTheme;
        if (typeof getUserTheme !== 'undefined' && getUserTheme() !== null) {
            originalTheme = getUserTheme();
        } else if (typeof getTheme !== 'undefined') {
            originalTheme = getTheme();
        } else {
            // Default to light mode
            originalTheme = 'light';
        }
        
        // Store original theme for reset functionality
        let savedTheme = originalTheme;
        
        // Set initial toggle state
        themeToggle.checked = originalTheme === 'dark';
        
        // Check if there are unsaved changes
        function checkForChanges() {
            const currentTheme = themeToggle.checked ? 'dark' : 'light';
            const hasChanges = currentTheme !== savedTheme;
            
            // Show/hide save and reset buttons
            if (hasChanges) {
                saveThemeBtn.style.display = 'inline-block';
                resetThemeBtn.style.display = 'inline-block';
            } else {
                saveThemeBtn.style.display = 'none';
                resetThemeBtn.style.display = 'none';
            }
        }
        
        // Handle theme toggle - preview only (don't save to database)
        themeToggle.addEventListener('change', function() {
            const newTheme = this.checked ? 'dark' : 'light';
            if (typeof setTheme === 'function') {
                setTheme(newTheme, false); // false = preview only, don't save to database
            }
            checkForChanges();
        });
        
        // Handle save button click - save to database
        saveThemeBtn.addEventListener('click', function() {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            
            // Save to database via API
            fetch('/api/settings/theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ theme: newTheme })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to save theme');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update saved theme
                    savedTheme = newTheme;
                    
                    // Update window.userTheme so it persists
                    if (typeof window !== 'undefined') {
                        window.userTheme = newTheme;
                        if (typeof localStorage !== 'undefined') {
                            localStorage.setItem('userTheme', newTheme);
                        }
                    }
                    
                    // Hide save/reset buttons
                    saveThemeBtn.style.display = 'none';
                    resetThemeBtn.style.display = 'none';
                    
                    // Show success message (optional)
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alert.innerHTML = '<strong>Success!</strong> Theme preference saved.';
                    alert.innerHTML += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                    const cardBody = themeToggle.closest('.card-body');
                    cardBody.appendChild(alert);
                    
                    // Remove alert after 3 seconds
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error saving theme:', error);
                
                // Show error message
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alert.innerHTML = '<strong>Error!</strong> ' + error.message;
                alert.innerHTML += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
                const cardBody = themeToggle.closest('.card-body');
                cardBody.appendChild(alert);
                
                // Remove alert after 5 seconds
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            });
        });
        
        // Handle reset button click - revert to saved theme
        resetThemeBtn.addEventListener('click', function() {
            // Reset toggle to saved theme
            themeToggle.checked = savedTheme === 'dark';
            
            // Apply saved theme (preview only)
            if (typeof setTheme === 'function') {
                setTheme(savedTheme, false); // false = preview only
            }
            
            // Hide save/reset buttons
            saveThemeBtn.style.display = 'none';
            resetThemeBtn.style.display = 'none';
        });
        
        // Initial check
        checkForChanges();
    }
    
    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeSettings);
    } else {
        initializeSettings();
    }
</script>
