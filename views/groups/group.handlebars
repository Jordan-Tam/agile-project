{{> header}}
<div class="group-container">

{{!--   {{#if groups}}
    <h2>All Groups</h2>
    <ul>
      {{#each groups}}
        <li>
          <a href="/groups/{{this._id}}">{{this.groupName}}</a>
          {{#if this.groupDescription}}
            <p>{{this.groupDescription}}</p>
          {{/if}}
        </li>
      {{/each}}
    </ul>
  {{else}}
    {{#unless group}}
      <p>No groups yet. Create your first group!</p>
    {{/unless}}
  {{/if}} --}}

  {{#if group}}
    {{!-- <hr> --}}
    <h1>{{group_name}}</h1>
    <p>{{group_description}}</p>

     <div class="group-actions">
    <form action="/groups/{{group._id}}/expense/new" method="get" style="display:inline;">
      <button type="submit">Add Expense</button>
    </form>

    <form action="/groups/{{group._id}}/addMember" method="get" style="display:inline;">
      <button type="submit">Add Member</button>
    </form>

    <form action="/groups/{{group._id}}/removeMember" method="get" style="display:inline;">
        <button type="submit">Remove Member</button>
    </form>

    <form action="/groups/{{group._id}}/edit" method="get" style="display:inline;">
      <button type="submit">Edit Group</button>
    </form>

    <form action="/groups/{{group._id}}" method="post" style="display:inline;">
        <input type="hidden" name="_method" value="DELETE">
        <button type="submit">Delete Group</button>
    </form>

    <button type="button" id="changeCurrencyBtn">Change Currency</button>
    <form action="/groups/{{group._id}}/export-pdf" method="get" style="display:inline;">
      <button type="submit" class="btn-export">Export PDF</button>
    </form>
  </div>
  
   {{#if success}}
    <p class="success">{{success}}</p>
  {{/if}}

  {{#if error}}
    <p class="error">{{error}}</p>
  {{/if}}

    {{#if groupMembers}}
      <br>
      <h3>Group Members</h3>
      <ul class="member-list">
        {{#each groupMembers}}
          <li class="member-item">
            <span class="member-name">{{this.firstName}} {{this.lastName}}</span>
            {{#with (lookup ../balances this._id)}}
              <ul class="balance-list">
                {{#each owes}}
                  <li class="balance-item">Owes {{this.creditorName}} <strong>${{this.amount}}</strong></li>
                {{/each}}
              </ul>
            {{else}}
              <span class="no-debts">(No outstanding debts)</span>
            {{/with}}
          </li>
        {{/each}}
      </ul>
    {{/if}}

    <h3>Expenses</h3>
      {{#if hasExpenses}}
          <div class="expenses-list">
              {{#each expenses}}
                  <div class="expense-item">
                      <div class="expense-info">
                          <h3>{{this.name}}</h3>
                          <p class="expense-cost">{{formatCurrency this.cost group.currency}}</p>
                          <p class="expense-deadline">Due: {{this.deadline}}</p>
                          {{#if this.file}}
                              <p class="expense-file">
                                  ðŸ“Ž <a href="/groups/{{../group_id}}/expense/{{this._id}}/file" target="_blank">{{this.file.originalName}}</a>
                                  <small>({{this.file.size}} bytes)</small>
                              </p>
                          {{/if}}
                      </div>
                    <div class="expense-actions">
                        <button class="btn btn-info view-details-btn" 
                                data-expense-id="{{this._id}}"
                                data-expense-name="{{this.name}}"
                                data-expense-cost="{{this.cost}}"
                                data-expense-deadline="{{this.deadline}}"
                                data-expense-payee="{{this.payeeName}}"
                                data-expense-payers='{{{json this.payerShares}}}'
                                data-amount-per-payer="{{this.amountPerPayer}}"
                                data-has-file="{{#if this.file}}true{{else}}false{{/if}}"
                                data-file-name="{{this.file.originalName}}">
                            View Details
                        </button>
                        <!-- NEW: Update Balance button visible only if current user owes > 0 -->
                        {{#ifEquals ../currentUserId ""}} 
                        <!-- no-op: if no currentUserId -->
                        {{else}}
                        {{!-- find if amountOwedForCurrentUser > 0 --}} 
                        {{#if this.amountOwedForCurrentUser}}
                            <button class="btn btn-warning update-balance-btn"
                                    data-expense-id="{{this._id}}"
                                    data-owed="{{this.amountOwedForCurrentUser}}">
                            Update Balance
                            </button>
                        {{/if}}
                        {{/ifEquals}}
                        <button class="btn btn-success archive-expense-btn" 
                                data-expense-id="{{this._id}}"
                                data-group-id="{{../group_id}}">
                            Archive
                        </button>
                        <button class="btn btn-danger delete-expense-btn" 
                                data-expense-id="{{this._id}}"
                                data-group-id="{{../group_id}}">
                            Delete
                        </button>
                    </div>
                  </div>
              {{/each}}
          </div>
      {{else}}
          <p class="no-expenses">No expenses yet. Create one to get started!</p>
      {{/if}}
  </div>

  <!-- Expense Details Modal -->
  <div id="expenseModal" class="modal">
      <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Expense Details</h2>
        <div id="modalBody">
            <p><strong>Name:</strong> <span id="modal-name"></span></p>
            <p><strong>Cost:</strong> <span id="modal-cost" data-currency-display></span></p>
            <p><strong>Deadline:</strong> <span id="modal-deadline"></span></p>
            <p><strong>Payee:</strong> <span id="modal-payee"></span></p>
            <p id="modal-file-section" style="display:none;">
                <strong>Attachment:</strong> 
                <a id="modal-file-link" href="#" target="_blank">
                    ðŸ“Ž <span id="modal-file-name"></span>
                </a>
            </p>
            <p><strong>Payers & Amount Owed:</strong></p>
            <ul id="modal-payers"></ul>
        </div>
        <div class="modal-actions">
            <button id="editExpenseBtn" class="btn btn-primary">Edit Expense</button>
            <button id="updateBalanceBtn" class="btn btn-success">Update Balance</button>
        </div>
      </div>
  </div>

  <!-- Change Currency Modal -->
  <div id="currencyModal" class="modal">
      <div class="modal-content">
          <span class="close-currency">&times;</span>
          <h2>Change Currency</h2>
          <form id="changeCurrencyForm">
              <label for="currencySelect">Select Currency:</label>
              <select id="currencySelect" name="currency" required>
                  <option value="USD" {{#ifEquals group.currency 'USD'}}selected{{/ifEquals}}>USD ($) - US Dollar</option>
                  <option value="EUR" {{#ifEquals group.currency 'EUR'}}selected{{/ifEquals}}>EUR (â‚¬) - Euro</option>
                  <option value="GBP" {{#ifEquals group.currency 'GBP'}}selected{{/ifEquals}}>GBP (Â£) - British Pound</option>
                  <option value="JPY" {{#ifEquals group.currency 'JPY'}}selected{{/ifEquals}}>JPY (Â¥) - Japanese Yen</option>
                  <option value="CAD" {{#ifEquals group.currency 'CAD'}}selected{{/ifEquals}}>CAD (CA$) - Canadian Dollar</option>
                  <option value="AUD" {{#ifEquals group.currency 'AUD'}}selected{{/ifEquals}}>AUD (A$) - Australian Dollar</option>
                  <option value="CHF" {{#ifEquals group.currency 'CHF'}}selected{{/ifEquals}}>CHF - Swiss Franc</option>
                  <option value="CNY" {{#ifEquals group.currency 'CNY'}}selected{{/ifEquals}}>CNY (Â¥) - Chinese Yuan</option>
                  <option value="INR" {{#ifEquals group.currency 'INR'}}selected{{/ifEquals}}>INR (â‚¹) - Indian Rupee</option>
                  <option value="MXN" {{#ifEquals group.currency 'MXN'}}selected{{/ifEquals}}>MXN (MX$) - Mexican Peso</option>
              </select>
              <div class="modal-actions">
                  <button type="submit" class="btn btn-primary">Save Currency</button>
                  <button type="button" class="btn btn-secondary" id="cancelCurrencyBtn">Cancel</button>
              </div>
          </form>
      </div>
  </div>
  <!-- Update Balance Modal -->
  <div id="balanceModal" class="modal">
      <div class="modal-content">
          <span class="close-balance">&times;</span>
          <h2>Update Balance</h2>
          <div id="balanceModalBody">
              <p>You owe: <span id="balance-owed"></span></p>
              <label for="paymentAmount">Payment Amount:</label>
              <input type="number" id="paymentAmount" min="0" step="0.01" placeholder="0.00">
              <p id="balanceError" class="error" style="display:none;"></p>
          </div>
          <div class="modal-actions">
              <button id="submitPaymentBtn" class="btn btn-primary">Submit Payment</button>
              <button id="cancelBalanceBtn" class="btn btn-secondary">Cancel</button>
          </div>
      </div>
  </div>
  {{/if}}
  <script>
      // Currency formatting helper
      const currencySymbols = {
          'USD': '$',
          'EUR': 'â‚¬',
          'GBP': 'Â£',
          'JPY': 'Â¥',
          'CAD': 'CA$',
          'AUD': 'A$',
          'CHF': 'CHF',
          'CNY': 'Â¥',
          'INR': 'â‚¹',
          'MXN': 'MX$'
      };

      let currentCurrency = '{{group.currency}}' || 'USD';

      function formatCurrency(amount, currencyCode) {
          const symbol = currencySymbols[currencyCode] || currencyCode;
          const numAmount = Number(amount);

          // For JPY and CNY, no decimal places
          if (currencyCode === 'JPY' || currencyCode === 'CNY') {
              return `${symbol}${Math.round(numAmount)}`;
          }

          return `${symbol}${numAmount.toFixed(2)}`;
      }

      function updateAllCurrencyDisplays() {
          // Update all expense costs in the list
          document.querySelectorAll('.expense-cost').forEach(el => {
              const rawCost = el.textContent.replace(/[^0-9.]/g, '');
              el.textContent = formatCurrency(rawCost, currentCurrency);
          });

          // Update modal if it has a cost displayed
          const modalCost = document.getElementById('modal-cost');
          if (modalCost && modalCost.dataset.rawCost) {
              modalCost.textContent = formatCurrency(modalCost.dataset.rawCost, currentCurrency);
          }
      }

      // Modal functionality
      const modal = document.getElementById('expenseModal');
      const closeBtn = document.querySelector('.close');
      const viewDetailsBtns = document.querySelectorAll('.view-details-btn');
      let currentExpenseId = null;

    viewDetailsBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            currentExpenseId = this.getAttribute('data-expense-id');
            const name = this.getAttribute('data-expense-name');
            const cost = this.getAttribute('data-expense-cost');
            const deadline = this.getAttribute('data-expense-deadline');
            const payee = this.getAttribute('data-expense-payee');
            const hasFile = this.getAttribute('data-has-file') === 'true';
            const fileName = this.getAttribute('data-file-name');

            // Parse payers JSON safely (we wrapped JSON in single quotes in the template)
            let payers = [];
            try {
                const raw = this.getAttribute('data-expense-payers') || '[]';
                payers = JSON.parse(raw);
            } catch (err) {
                // Fallback: try splitting as array of names (backwards compatibility)
                const raw = this.getAttribute('data-expense-payers') || '[]';
                try {
                    payers = JSON.parse(raw.replace(/'/g, '"'));
                } catch (e) {
                    payers = [];
                }
            }

    // amountPerPayer may be present as numeric string
    const amountPerPayerAttr = this.getAttribute('data-amount-per-payer');
    const amountPerPayer = amountPerPayerAttr ? Number(amountPerPayerAttr) : undefined;

    document.getElementById('modal-name').textContent = name;

    const modalCostEl = document.getElementById('modal-cost');
    modalCostEl.dataset.rawCost = cost;
    modalCostEl.textContent = formatCurrency(cost, currentCurrency);

    document.getElementById('modal-deadline').textContent = deadline;
    document.getElementById('modal-payee').textContent = payee;

    // Handle file display
    const fileSection = document.getElementById('modal-file-section');
    if (hasFile && fileName) {
        document.getElementById('modal-file-name').textContent = fileName;
        document.getElementById('modal-file-link').href = `/groups/{{group_id}}/expense/${currentExpenseId}/file`;
        fileSection.style.display = 'block';
    } else {
        fileSection.style.display = 'none';
    }

    const payersList = document.getElementById('modal-payers');
    payersList.innerHTML = '';

    // payer can be either a string (older code) or object { _id, name, owed }
    payers.forEach(payer => {
        const li = document.createElement('li');
        let payerName = '';
        let owedAmount = undefined;

        if (typeof payer === 'string') {
            payerName = payer;
            owedAmount = amountPerPayer;
        } else if (payer && typeof payer === 'object') {
            // support both {name, owed} and {payer, paid, ...}
            payerName = payer.name || payer.payer || payer.user || JSON.stringify(payer);
            owedAmount = (payer.owed !== undefined) ? Number(payer.owed) : amountPerPayer;
        } else {
            payerName = String(payer);
            owedAmount = amountPerPayer;
        }

        // If we don't know owedAmount, show just name
        if (owedAmount === undefined || isNaN(owedAmount)) {
            li.textContent = payerName;
        } else {
            li.textContent = `${payerName}: ${formatCurrency(owedAmount, currentCurrency)}`;
        }
        payersList.appendChild(li);
    });

    modal.style.display = 'block';
});
});

    // Edit expense button handler
    document.getElementById('editExpenseBtn').addEventListener('click', function() {
        if (currentExpenseId) {
            window.location.href = `/groups/{{group_id}}/expense/${currentExpenseId}/edit`;
        }
    });

    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

      // Delete expense functionality
      const deleteExpenseBtns = document.querySelectorAll('.delete-expense-btn');

      deleteExpenseBtns.forEach(btn => {
          btn.addEventListener('click', async function() {
              if (!confirm('Are you sure you want to delete this expense?')) {
                  return;
              }

              const expenseId = this.getAttribute('data-expense-id');
              const groupId = this.getAttribute('data-group-id');

              try {
                  const response = await fetch(`/groups/${groupId}/${expenseId}`, {
                      method: 'DELETE',
                      headers: {
                          'Content-Type': 'application/json'
                      }
                  });

                  if (response.ok) {
                      // Reload the page to show updated expense list
                      window.location.reload();
                  } else {
                      const error = await response.json();
                      alert('Error deleting expense: ' + (error.error || 'Unknown error'));
                  }
              } catch (error) {
                  alert('Error deleting expense: ' + error.message);
              }
          });
      });
      // Add after deleteExpenseBtns code block

    // Update Balance button handlers (on expense cards)
    const updateBalanceBtns = document.querySelectorAll('.update-balance-btn');
    updateBalanceBtns.forEach(btn => {
        btn.addEventListener('click', async function () {
            const expenseId = this.getAttribute('data-expense-id');
            const owedStr = this.getAttribute('data-owed');
            const owed = Number(owedStr);

            if (isNaN(owed) || owed <= 0) {
                alert('You do not owe anything for this expense.');
                return;
            }

            // Ask the user for a payment amount. Using prompt for quick UI; you can replace with a modal.
            let input = prompt(`Enter payment amount between 0 and ${formatCurrency(owed, currentCurrency)}`, owed.toFixed(2));
            if (input === null) return; // user cancelled

            // Clean input
            input = input.replace(/[^0-9.\-]/g, '').trim();
            const paymentAmount = parseFloat(input.trim());
            if (isNaN(paymentAmount)) {
                alert('Invalid amount entered');
                return;
            }
            if (paymentAmount < 0) {
                alert('Payment cannot be negative');
                return;
            }
            if (paymentAmount > owed + 0.0001) {
                alert(`Payment cannot exceed ${formatCurrency(owed, currentCurrency)}`);
                return;
            }

            try {
                const response = await fetch(`/groups/{{group._id}}/updateBalance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expenseId, paymentAmount })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Reload to reflect new balances and amounts
                    window.location.reload();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error updating balance: ' + e.message);
            }
        });
    });

      // Currency modal functionality
      const currencyModal = document.getElementById('currencyModal');
      const changeCurrencyBtn = document.getElementById('changeCurrencyBtn');
      const closeCurrencyBtn = document.querySelector('.close-currency');
      const cancelCurrencyBtn = document.getElementById('cancelCurrencyBtn');
      const changeCurrencyForm = document.getElementById('changeCurrencyForm');

      if (changeCurrencyBtn) {
          changeCurrencyBtn.addEventListener('click', function() {
              currencyModal.style.display = 'block';
          });
      }

      if (closeCurrencyBtn) {
          closeCurrencyBtn.addEventListener('click', function() {
              currencyModal.style.display = 'none';
          });
      }

      if (cancelCurrencyBtn) {
          cancelCurrencyBtn.addEventListener('click', function() {
              currencyModal.style.display = 'none';
          });
      }

      window.addEventListener('click', function(event) {
          if (event.target === currencyModal) {
              currencyModal.style.display = 'none';
          }
      });

      // Handle currency change form submission
      if (changeCurrencyForm) {
          changeCurrencyForm.addEventListener('submit', async function(e) {
              e.preventDefault();

              const selectedCurrency = document.getElementById('currencySelect').value;

              try {
                  const response = await fetch('/groups/{{group._id}}/changeCurrency', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ currency: selectedCurrency })
                  });

                  if (response.ok) {
                      const data = await response.json();
                      // Reload page to show converted expense amounts
                      window.location.reload();
                  } else {
                      const error = await response.json();
                      alert('Error updating currency: ' + (error.error || 'Unknown error'));
                  }
              } catch (error) {
                  alert('Error updating currency: ' + error.message);
              }
          });
      }
      // Balance update modal functionality
      const balanceModal = document.getElementById('balanceModal');
      const closeBalanceBtn = document.querySelector('.close-balance');
      const updateBalanceBtn = document.getElementById('updateBalanceBtn');
      const cancelBalanceBtn = document.getElementById('cancelBalanceBtn');
      const submitPaymentBtn = document.getElementById('submitPaymentBtn');
      const paymentAmountInput = document.getElementById('paymentAmount');
      const balanceError = document.getElementById('balanceError');
      
      let currentPayee = null;
      let currentAmountOwed = null;

      updateBalanceBtn.addEventListener('click', function() {
          // Get the payee from the modal
          currentPayee = document.getElementById('modal-payee').textContent;
          currentAmountOwed = parseFloat(
              document.getElementById('modal-cost').textContent.replace(/[^0-9.]/g, '')
          );

          // Clear previous values
          paymentAmountInput.value = '';
          balanceError.style.display = 'none';
          document.getElementById('balance-owed').textContent = formatCurrency(currentAmountOwed, currentCurrency);

          modal.style.display = 'none';
          balanceModal.style.display = 'block';
      });

      closeBalanceBtn.addEventListener('click', function() {
          balanceModal.style.display = 'none';
      });

      cancelBalanceBtn.addEventListener('click', function() {
          balanceModal.style.display = 'none';
      });

      window.addEventListener('click', function(event) {
          if (event.target === balanceModal) {
              balanceModal.style.display = 'none';
          }
      });

      submitPaymentBtn.addEventListener('click', async function() {
          const paymentAmount = parseFloat(paymentAmountInput.value);

          // Validation
          if (isNaN(paymentAmount)) {
              balanceError.textContent = 'Please enter a valid amount';
              balanceError.style.display = 'block';
              return;
          }

          if (paymentAmount < 0) {
              balanceError.textContent = 'Payment amount cannot be negative';
              balanceError.style.display = 'block';
              return;
          }

          if (paymentAmount > currentAmountOwed) {
              balanceError.textContent = `Payment cannot exceed ${formatCurrency(currentAmountOwed, currentCurrency)}`;
              balanceError.style.display = 'block';
              return;
          }

          try {
              const response = await fetch(`/groups/{{group._id}}/updateBalance`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      expenseId: currentExpenseId,
                      paymentAmount: paymentAmount
                  })
              });

              if (response.ok) {
                  const data = await response.json();
                  balanceModal.style.display = 'none';
                  alert('Balance updated successfully!');
                  window.location.reload();
              } else {
                  const error = await response.json();
                  balanceError.textContent = error.error || 'Error updating balance';
                  balanceError.style.display = 'block';
              }
          } catch (error) {
              balanceError.textContent = 'Error updating balance: ' + error.message;
              balanceError.style.display = 'block';
          }
      });

      // Archive expense functionality
      const archiveExpenseBtns = document.querySelectorAll('.archive-expense-btn');
      archiveExpenseBtns.forEach(btn => {
          btn.addEventListener('click', async function(event) {
              event.stopPropagation();
              const expenseId = this.getAttribute('data-expense-id');
              const groupId = this.getAttribute('data-group-id');

              if (confirm('Are you sure you want to archive this expense? You can view it later in the Logs section.')) {
                  try {
                      const response = await fetch(`/groups/${groupId}/${expenseId}/archive`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          }
                      });

                      if (response.ok) {
                          alert('Expense archived successfully!');
                          window.location.reload();
                      } else {
                          const data = await response.json();
                          alert('Error: ' + (data.error || 'Failed to archive expense'));
                      }
                  } catch (error) {
                      console.error('Error archiving expense:', error);
                      alert('An error occurred while archiving the expense');
                  }
              }
          });
      });

    // Initialize currency displays on page load
    updateAllCurrencyDisplays();
  </script>
</div>