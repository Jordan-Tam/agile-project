{{> header}}
<main>
    <div class="container-fluid">
        {{#if success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{success}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {{/if}}

        <div class="container-fluid rounded px-4 py-4 mb-3 bg-light">
            <h2 class="mb-4">Profile</h2>

            <div class="row">
                <!-- Left Column: Profile Photo, Name and User ID -->
                <div class="col-md-6">
                    <!-- Profile Icon -->
                    <div class="mb-4">
                        <img src="/public/profileIcon.jpg" alt="Profile Icon" class="rounded-circle" style="width: 80px; height: 80px;">
                    </div>
                    
                    <div class="mb-3">
                        <strong>Name:</strong> {{user.firstName}} {{user.lastName}}
                    </div>
                    <div class="mb-3">
                        <strong>User ID:</strong> {{user.userId}}
                    </div>
                    <div class="mb-3">
                        <p><strong>Total You Owe:</strong> ${{totalOwes}}</p>
                        <p><strong>Total Owed To You:</strong> ${{totalOwedTo}}</p>
                    </div>

                    <!-- Payment Statistics Section -->
                    <div class="mb-3 mt-4">
                        <h5>Payment Statistics</h5>
                        {{#if statsError}}
                            <div class="alert alert-danger" role="alert">
                                {{statsError}}
                            </div>
                        {{else if paymentStats}}
                            {{#if (or paymentStats.paymentCount paymentStats.earningCount)}}
                                <div class="card">
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Total Paid:</strong> ${{paymentStats.totalPaid}}</p>
                                        <p class="mb-2"><small class="text-muted">{{paymentStats.paymentCount}} payment(s) made</small></p>
                                        <p class="mb-2"><strong>Total Earned:</strong> ${{paymentStats.totalEarned}}</p>
                                        <p class="mb-2"><small class="text-muted">{{paymentStats.earningCount}} payment(s) received</small></p>
                                        <hr>
                                        <p class="mb-0">
                                            <strong>Net Balance:</strong>
                                            <span class="{{#if (gt paymentStats.netBalance 0)}}text-success{{else if (lt paymentStats.netBalance 0)}}text-danger{{else}}text-muted{{/if}}">
                                                ${{paymentStats.netBalance}}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            {{else}}
                                <div class="alert alert-info" role="alert">
                                    No payment data available yet.
                                </div>
                            {{/if}}
                        {{else}}
                            <div class="alert alert-info" role="alert">
                                No payment data available yet.
                            </div>
                        {{/if}}
                    </div>
                </div>

                <!-- Right Column: Groups -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>Groups:</strong>
                        {{#if userGroups.length}}
                            <ul class="list-unstyled mt-2">
                                {{#each userGroups}}
                                <li class="mb-2">
                                    <a href="/groups/{{this._id}}" class="text-decoration-none">
                                        {{this.groupName}}
                                    </a>
                                    {{#if this.groupDescription}}
                                    <small class="text-muted d-block">{{this.groupDescription}}</small>
                                    {{/if}}
                                    <form action="/profile/pinGroup" method="POST" style="display:inline;">
                                        <input type="hidden" name="groupId" value="{{this._id}}">
                                        {{#if (contains ../userPinnedGroups this._id)}}
                                            <input type="hidden" name="action" value="unpin">
                                            <button type="submit" style="background:none;border:none;color:orange;">üìå</button>
                                        {{else}}
                                            <input type="hidden" name="action" value="pin">
                                            <button type="submit" style="background:none;border:none;color:gray;">üìç</button>
                                        {{/if}}
                                    </form>
                                </li>

                                {{/each}}
                            </ul>
                        {{else}}
                            <div class="mt-2">
                                <span class="text-muted">Not a member of any groups yet</span>
                            </div>
                        {{/if}}
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col">
                    <a href="/profile/edit" class="btn btn-primary me-2">Edit Profile</a>
                    <a href="/signout" class="btn btn-warning me-2">Sign Out</a>
                    <form action="/profile" method="POST" style="display:inline;">
                        <input type="hidden" name="_method" value="DELETE">
                        <button class="btn btn-danger me-2" type="submit">Delete Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>